<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ü™ê Exoplanet Explorer ‚Äî Light Curve</title>

  <!-- Bootstrap Dark -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
  :root {
    --bs-body-bg: #0b0d11;
    --bs-body-color: #e2e2e2;
    --bs-card-bg: #1a1d23;
    --bs-card-border-color: #2a2d35;
    --bs-border-color: #2a2d35;
    --accent-color: #00b3ff;
  }

  body {
    background-color: var(--bs-body-bg);
    color: var(--bs-body-color);
    font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  h1 {
    font-weight: 700;
    color: #ffffff;
  }

  .card {
    background-color: var(--bs-card-bg);
    border: 1px solid var(--bs-card-border-color);
    border-radius: 0.75rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
  }

  .card-title {
    color: #ffffff;
    font-weight: 600;
  }

  .form-label {
    color: #cfd2d6;
  }

  .form-control {
    background-color: #20232b;
    color: #ffffff;
    border: 1px solid #383c46;
  }

  .form-control:focus {
    background-color: #252931;
    color: #ffffff;
    border-color: var(--accent-color);
    box-shadow: 0 0 0 0.2rem rgba(0, 179, 255, 0.25);
  }

  /* üåô DARK, WHITE AND COMPACT TABLE */
  .table {
    color: #ffffff;
    background-color: transparent;
    border-color: var(--bs-border-color);
    font-size: 0.83rem;
  }

  .table th {
    background-color: #101217;
    color: #ffffff;
    border-bottom: 2px solid #1f2630;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.8rem;
    white-space: nowrap;
  }

  .table td {
    color: #ffffff;
    white-space: nowrap;
    vertical-align: middle;
  }

  .table-striped > tbody > tr:nth-of-type(odd) > * {
    background-color: #1a1d23;
  }

  .table-striped > tbody > tr:nth-of-type(even) > * {
    background-color: #15181f;
  }

  .table-hover tbody tr:hover {
    background-color: #263044;
    cursor: pointer;
  }

  .table-active {
    background-color: rgba(0, 179, 255, 0.2) !important;
  }

  .text-muted {
    color: #aaaaaa !important;
  }

  .sim-area {
    height: 500px;
    position: relative;
    background: black;
    border-radius: 0.5rem;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sim-area canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* Dark scrollbar */
  ::-webkit-scrollbar {
    width: 10px;
  }
  ::-webkit-scrollbar-track {
    background: #121418;
  }
  ::-webkit-scrollbar-thumb {
    background-color: #343842;
    border-radius: 8px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background-color: #4d5260;
  }
</style>


</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">ü™ê Exoplanet Explorer</h1>

    <div class="row g-4">
      <!-- Left Panel -->
      <div class="col-lg-7">
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead>
                  <tr>
                    {% for col in table_columns %}
                    <th scope="col">{{ col }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for row in table_rows %}
                  <tr data-kepid="{{ row['kepid'] }}">
                    {% for col in table_columns %}
                    <td>{{ row[col] }}</td>
                    {% endfor %}
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="col-lg-5">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Light Curve</h5>
            <div class="chart-area">
              <canvas id="lightCurveChart"></canvas>
            </div>
          </div>
        </div>
        <div class="card mt-4">
          <div class="card-body">
            <h5 class="card-title">Result: </h5>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label"> Stellar radius (R‚òâ) </label>
                <input class="form-control" type="text" value="" step="any" name="stellar_radius_rsun" id="radii"/>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label"> Stellar mass (M‚òâ) </label>
                <input class="form-control" type="text" value="" step="any" name="stellar_mass_msun"  id="mass"/>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label"> Stellar Teff (K) </label>
                <input class="form-control" type="text" value="" step="any" name="stellar_teff" id="teff"/>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label"> Planet mass (M‚®Ä) </label>
                <input class="form-control" type="text" value="" step="any" name="stellar_mass_msun"  id="pmass"/>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label"> Planet Teff (K)</label>
                <input class="form-control" type="text" value="" step="any" name="stellar_teff" id="pteff"/>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Simulation (relative size and temperature color)</h5>
        <div class="sim-area">
          <canvas id="systemSim" class="w-100"></canvas>
        </div>
        <p class="text-muted small mb-0">
          The planet size is scaled by <code>R_p / R_‚òÖ</code>. The star color depends on <code>T_eff</code>,
          the planet color on its estimated <em>T_eq</em> (albedo 0.3). This is for illustration purposes only.
        </p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Script: Light Curve -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const table = document.querySelector("table");
      const canvas = document.getElementById("lightCurveChart");
      if (!table || !canvas) return;

      let chart;

      function renderLightCurve(time, flux, title) {
        const points = time.map((t, i) => ({ x: t, y: flux[i] }));
        const data = {
          datasets: [{
            label: title || "Light Curve",
            data: points,
            pointRadius: 1,
            hitRadius: 4,
            borderWidth: 1,
            borderColor: "#00b3ff",
            fill: false,
            showLine: true,
            tension: 0,
            spanGaps: true,
          }]
        };
        const options = {
          responsive: true,
          maintainAspectRatio: false,
          parsing: true,
          scales: {
            x: { type: "linear", title: { display: true, text: "Time", color: "#aaa" }, ticks: { color: "#aaa" } },
            y: { title: { display: true, text: "Flux", color: "#aaa" }, ticks: { color: "#aaa" } }
          },
          plugins: {
            legend: { labels: { color: "#ccc" } },
            tooltip: {
              mode: "nearest",
              intersect: false,
              callbacks: { label: (ctx) => `t=${ctx.parsed.x}, F=${ctx.parsed.y}` }
            },
            decimation: { enabled: true, algorithm: "lttb", samples: 2000 }
          },
          animation: false
        };

        if (chart) {
          chart.data = data;
          chart.options = options;
          chart.update();
        } else {
          chart = new Chart(canvas.getContext("2d"), { type: "line", data, options });
        }
      }

      table.addEventListener("click", async (e) => {
        const row = e.target.closest("tr[data-kepid]");
        if (!row) return;
        const kepid = row.getAttribute("data-kepid");
        if (!kepid) return;

        try {
          row.classList.add("table-active");
          const res = await fetch(`/light_curve?kepid=${encodeURIComponent(kepid)}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const payload = await res.json();
          const time = payload.time || [];
          const flux = payload.flux || [];
          if (!time.length || time.length !== flux.length) throw new Error("Invalid TIME/FLUX data");
          renderLightCurve(time, flux, `KIC-${kepid}`);
        } catch (err) {
          console.error("Error loading curve:", err);
          alert("Could not load light curve for the selected kepid.");
        } finally {
          setTimeout(() => row.classList.remove("table-active"), 300);
        }
      });
    });
  </script>

  <!-- Script: Results -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
    const table = document.querySelector("table");

    function updateResults(payload) {
      const radiiInput = document.getElementById("radii");
      const teffInput = document.getElementById("teff");
      const massInput = document.getElementById("mass");

      const pteffInput = document.getElementById("pteff");
      const pmassInput = document.getElementById("pmass");

      radiiInput.value = payload.start_raddii || "N/A";
      teffInput.value  = payload.start_teff   || "N/A";
      massInput.value  = payload.start_mass   || "N/A";

      pteffInput.value  = payload.planet_teff   || "N/A";
      pmassInput.value  = payload.planet_radii   || "N/A";
    }

    table.addEventListener("click", async (e) => {
      const row = e.target.closest("tr[data-kepid]");
      if (!row) return;
      const kepid = row.getAttribute("data-kepid");
      if (!kepid) return;

      try {
        row.classList.add("table-active");
        const res = await fetch(`/system_parameters?kepid=${encodeURIComponent(kepid)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const payload = await res.json();
        updateResults(payload);

        drawSimulation(
          payload.start_raddii || 1,
          payload.start_teff || 5800,
          payload.planet_radii || 0.1,
          payload.planet_teff || 300
        );

      } catch (err) {
        console.error("Error loading results:", err);
        alert("Could not load results for the selected kepid.");
      } finally {
        setTimeout(() => row.classList.remove("table-active"), 300);
      }
    });
  });
  </script>

  <!-- Script: Simulation -->
  <script>
   function drawSimulation(starRadius = 1, starTeff = 5800, planetRadius = 0.1, planetTeff = 300) {
  const c = document.getElementById("systemSim");
  const ctx = c.getContext("2d");
  const dpr = window.devicePixelRatio || 1;

  c.width = c.clientWidth * dpr;
  c.height = c.clientHeight * dpr;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  const W = c.width / dpr;
  const H = c.height / dpr;
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, W, H);

  const starCount = 250;
  for (let i = 0; i < starCount; i++) {
    const x = Math.random() * W;
    const y = Math.random() * H;
    const size = Math.random() * 1.5;
    const alpha = 0.3 + Math.random() * 0.7;

    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();
  }

  const starR   = Math.min(W, H) * 0.15 * (starRadius / 1.0);
  const planetR = 10;

  const kelvinToRGB = (tempK) => {
    let t = Math.max(1000, Math.min(40000, tempK)) / 100;
    let r, g, b;

    if (t <= 66) r = 255;
    else r = 329.698727446 * Math.pow(t - 60, -0.1332047592);

    if (t <= 66)
      g = 99.4708025861 * Math.log(t) - 161.1195681661;
    else
      g = 288.1221695283 * Math.pow(t - 60, -0.0755148492);

    if (t >= 66) b = 255;
    else if (t <= 19) b = 0;
    else b = 138.5177312231 * Math.log(t - 10) - 305.0447927307;

    const clamp = v => Math.max(0, Math.min(255, Math.round(v)));
    return { r: clamp(r), g: clamp(g), b: clamp(b) };
  };

  const starX = W * 0.35;
  const starY = H * 0.5;

  const sc = kelvinToRGB(starTeff);
  ctx.beginPath();
  ctx.fillStyle = `rgb(${sc.r}, ${sc.g}, ${sc.b})`;
  ctx.shadowColor = `rgba(${sc.r}, ${sc.g}, ${sc.b}, 1)`;
  ctx.shadowBlur = 20;
  ctx.arc(starX, starY, starR, 0, Math.PI * 2);
  ctx.fill();

  const planetX = W * 0.75;
  const planetY = H * 0.5;

  ctx.beginPath();
  ctx.fillStyle = `rgb(${Math.min(255, planetTeff / 10)}, ${Math.min(255, planetTeff / 20)}, 100)`;
  ctx.shadowColor = ctx.fillStyle;
  ctx.shadowBlur = 10;
  ctx.arc(planetX, planetY, planetR, 0, Math.PI * 2);
  ctx.fill();

  ctx.shadowBlur = 0;
}
document.addEventListener("DOMContentLoaded", drawSimulation);
  </script>
</body>
</html>
